---
title: "ER model for NHC"
author: "Alice Carter"
date: "2/2022"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = 'C:/Users/Alice Carter/git/nhc_50yl')
setwd('C:/Users/Alice Carter/git/nhc_50yl/')
library(tidyverse)
library(rstan)
library(bayesplot)
dat <- read_csv('data/metabolism/metabolism_and_drivers.csv')

```
Overview: We are building a model of ecosystem respiration based on physical drivers using our modern dataset from New Hope Creek. We will then use this model to predict respiration rates that we would have expected in 1969 based on this modern understanding. To test our understanding of how the ecosystem metabolism has changed over 50 years, we will compare these predictions to measured rates of ER in the past.

Outline:
1. Build a state space model of respiration as a function of discharge, water temperature, and litterfall with a latent carbon storage state. 
2. Test model on simulated data.
3. Adapt model to incorporate missing data.
4. Fit model to modern NHC data at one site.

Next steps:
- Expand model to a hierarchical structure that allows for information sharing across sites.
- Use model to predict rates of ER in the past
- Compare monthly averaged rates to measured past values.

### Model Description

We will model respiration ($R$) as a function of the productivity ($P$), the carbon storage available for respiration ($C$), and temperature ($T$). The carbon stored in the stream is a latent state in the model that will evolve as a random walk with removal through discharge and respiration, and additions through annual litterfall ($L$). 

#### Process model

$$ R_t = \beta_1 C_t * e ^ {E/k_b T} + AR*P_t$$
$$ C_t = C_{t-1} + L_t - R_{t-1} - \beta_2 Q_t C_{t-1} + \epsilon_t$$
$$ \epsilon_t \sim N(0, \sigma_{proc})$$

Where $\beta$ are parameters to be estimated, $E$ is the activation energy for heterotrophic respiration, $k_b$ is Boltzman's constant, $AR$ is the fraction of autotrophic respiration (fixed at 0.5 in this model). Litterfall ($L$) is a fixed constant $l$ representing the annual litterfall (500 g/m2/y) divided by the number of days of leaf off (20 days) multiplied by a vector of zeros and ones representing the time period of leaf off.

#### Observation model

$$R_{obs,t} \sim N(R_t, \sigma_{obs})$$


#### Priors

$$E \sim N(0.65, 0.1)$$
$$\beta_1 \sim N(0, 1)$$
$$\beta_2 \sim N(0,1)$$
$$\sigma_{proc} \sim N(0,1), \sigma_{proc} > 0$$
$$\sigma_{obs} \sim N(0,1), \sigma_{obs} > 0$$

### Simulate data

Use real input data to simulate ER and GPP:

```{r, echo = FALSE}
cbp <- dat %>%
  filter(site == 'CBP') %>%
  arrange(date) %>% 
  select(date, ER, GPP, temp.water, discharge, PAR_surface) %>%
  group_by(date) %>%
  summarize(across(everything(), mean, na.rm = T)) %>%
  ungroup() %>%
  mutate(across(-date, zoo::na.approx, na.rm = F)) %>%
  filter(!is.na(ER))

# define litterfall to be 20 days from Oct 5th - 24th with the total annual litter = 500 gC/m2/y, so daily litterfall = 25 gC/m2/d
cbp <- mutate(cbp, litter = case_when(date >= as.Date('2019-10-05') & 
                                        date <= as.Date('2019-10-24') ~ 25,
                                      TRUE ~ 0))
mutate(cbp, logQ = log(discharge)) %>%
  select(date, temp = temp.water, logQ, light = PAR_surface, litter) %>%
  pivot_longer(-date, names_to = 'variable', values_to = 'value') %>%
  ggplot(aes(date, value, col = variable)) +
  geom_line() +
  facet_wrap(.~variable, nrow = 4, scales = 'free_y')
  
```

```{r}
N <- nrow(cbp)
light = cbp$PAR_surface/max(cbp$PAR_surface)
Q = cbp$discharge/max(cbp$discharge)
temp = cbp$temp.water + 273


litter = cbp$litter

# simulate GPP
P <- numeric()
P[1] = 0.5
for(i in 2:N){
  P[i] = 0.5 * P[i-1] + 0.8 * light[i] + rnorm(1,0, 0.05)
}

# define parameters
b1 = .5 * 10e8 # I can only get a measurable amount of heterotrophic respiration with an extremely high b1 
b2 = .8
E = 0.63
sigma_proc = 0.1
sigma_obs = 0.05 # adjust this based on the actual measurement error in the data

# Constants
k_b = 8.6173 * 10^-5
AR = 0.5

# Process model
C = numeric()
R = numeric()
R_obs = numeric()
C[1] = 100 # initial accessible carbon storage in stream
R[1] = b1 * C[1] * exp(-E/(k_b * temp[1])) + AR * P[1]

for(i in 2:N){
  C[i] = (C[i-1] + litter[i] - R[i-1] + P[i-1])*(1-b2*Q[i]) + rnorm(1, 0, sigma_proc)
  if(C[i]<0) C[i] = 0
  R[i] = b1 * C[i] * exp(-E/(k_b * temp[i])) + AR * P[i]
}

R_obs = rnorm(N, R, sigma_obs)

data.frame(date = cbp$date, P = P, R = R_obs, C = C) %>%
  pivot_longer(-date, names_to = 'var', values_to = 'value') %>%
  ggplot(aes(date, value, col = var)) +
  geom_line()+
  facet_wrap(.~var, scales = 'free_y', nrow = 3)

```

### Stan Code

First, we will try a simpler model where we include the carbon storage as an input rather than modeling it as a latent state:

```{r, comment='', echo = FALSE}
cat(read_lines('src/model/stan/ER_base_model_1.stan'), sep = '\n')
```

Running this model on our simulated data, we are somewhat able to recover parameters:

```{r, eval = FALSE}
stan_dat <- list(N = length(R_obs), R_obs = R_obs, P_obs = P,
                 tempK = temp, C = C)

mod <- stan('src/model/ss_ER.stan', 
            data = stan_dat,
            chains = 4, init = 0,
            warmup = 500, iter = 1000)
```


```{r, echo = FALSE}
mod <- readRDS('src/model/model_runs/simulated_ER_base_mod_1.rds')
traceplot(mod, ncol = 1)

```

The chains look fine, and are spot on for the activation energy, E, and the observation error, but the model estimate for $\beta_1$ is ~3.7, while the true value is 0.5

While this needs to be addressed, I will try running the more complex model with C as an underlying latent state:

### State space ER model:

```{r, comment='', echo = FALSE}
cat(read_lines('src/model/ss_ER.stan'), sep = '\n')
```

```{r, eval = FALSE}
stan_dat <- list(N = length(R_obs), R_obs = R_obs, P_obs = P,
                 tempK = temp, Q = Q, litter = litter, C0 = C[1])

mod2 <- stan('src/model/ss_ER.stan', 
            data = stan_dat, init = 0,
            chains = 4, cores = 4, 
            warmup = 200, iter = 500)
```

```{r, echo = FALSE}
# saveRDS(mod, 'src/model/model_runs/simulated_ss_ER.rds')
mod2 <- readRDS('src/model/model_runs/simulated_ss_ER.rds')
traceplot(mod2, ncol = 1, pars=c('b1', 'b2', 'E', 'sigma_obs', 'sigma_proc'))
```

For this model, parameter recovery of $\beta_1$, $E$, and $\sigma_{obs}$ is similar to the simpler model ($\beta_1$ is still too high). $\beta_2$ is right on at 0.8, but $\sigma_{proc}$ is not converging.

```{r}
fit <- summary(mod2)
modC <- fit$summary[4:363,1] 
modC_sd <- fit$summary[4:363,3]

plot(cbp$date, C, type = 'l', ylab = 'Carbon (g/m2)', xlab = 'Date')
points(cbp$date, modC)
legend('topleft', c('underlying state', 'modeled'), 
       lty = c(1,0), pch = c(NA,1), bty = 'n')

```
