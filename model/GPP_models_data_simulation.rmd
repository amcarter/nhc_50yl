---
title: "GPP model for NHC"
author: "Alice Carter"
date: "2/15/2022"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = 'C:/Users/Alice Carter/git/nhc_50yl')
setwd('C:/Users/Alice Carter/git/nhc_50yl')
library(tidyverse)
```
Task: build a basic hierarchical model of productivity as a function of light, temperature, and discharge.

### Initial model

To start, I will model productivity $P$ as an autoregressive function with terms for light ($l$), temp ($T$), and discharge ($Q$) included. If this proves insufficient, I will incorporate a latent biomass term.

$$P_t = \phi P_{t-1} + \beta_1 l_t + \beta_2 T_t + \beta_3 log(Q_t) + \epsilon_t$$
$$\epsilon_t \sim N(0,\sigma_{proc})$$
$$P_{obs,t} \sim N(P_t, sigma_{obs})$$
Simulate some data based on real driver variables:

```{r}

dat <- read_csv("data/metabolism/metabolism_and_drivers.csv")
drivers <- dat %>%
  filter(site == 'CBP') %>%
  mutate(GPP_sd = (GPP.upper - GPP.lower)*.33/.95) %>%
  select(date, PAR_surface, LAI, temp.water, discharge, GPP, GPP_sd) %>%
  mutate(across(-date, zoo::na.approx, na.rm = F),
         logQ = (log(discharge)),
         tQ = discharge/max(discharge, na.rm = T),
         light = PAR_surface/max(PAR_surface, na.rm = T)) %>%
  arrange(date)
drivers <- drivers %>%
  mutate(GPP_l = c(NA, GPP[1:(n()-1)] ))

phi = 0.949
b_light = 0.0577
# b_temp = 0.001
b_q = 0.132
sig_o = 0.05
sig_p = 0.05

Phat = P = numeric()
Phat[1] = P[1] = 1
N = nrow(drivers)

for (i in 2:N){
  Phat[i] = phi *Phat[i-1] + b_light * drivers$light[i] 
  P[i] = rnorm(1, Phat[i], sig_p)
  if(P[i] < 0) P[i] = 0
}

P_obs <- rnorm(N, P, sig_o)

plot(drivers$date, P_obs, ylim = c(0, 2))
lines(drivers$date, drivers$GPP)
lines(drivers$date, drivers$light, col = 2)
lines(drivers$date, drivers$temp.water/2 + .7, col = 4)
lines(drivers$date, drivers$logQ/3 + 1, col = 3)
lines(drivers$date, drivers$LAI/3)
plot(drivers$GPP, P_obs)
abline(0,1)
m <- lm(GPP ~ GPP_l + light, data = drivers)

summary(m)
```

```{r}
## Growth Model 1 - Data simulation 

PM_AR <- function(phi, alpha, beta, sig_p, sig_o, df) {
  ## Data
  Ndays<-length(df$GPP)
  GPP <- df$GPP
  GPP_sd <- df$GPP_sd
  light <- df$light
  tQ <- df$tQ # discharge standardized to max value
  
  ## Vectors for model output
  pred_GPP<-numeric(Ndays)
  pred_GPP[1] <- GPP[1]
  l_pred_GPP <- numeric(Ndays)
  l_pred_GPP[1] <- log(GPP[1])
  
  ## Process model
  for (j in 2:Ndays) {
    l_pred_GPP[j] = MCMCglmm::rtnorm(1, mean=phi*l_pred_GPP[j-1] + alpha*light[j] + beta*tQ[j], sd = sig_p, upper=5)
  }
  
  for (i in 2:Ndays){
  pred_GPP[i] <- MCMCglmm::rtnorm(1, mean = exp(l_pred_GPP[i]), sd = sig_o, lower=0.01)
  }
  
  return(pred_GPP)
}


PM_AR(phi, b_light, b_q, 0.1, 0.1, drivers)

```

### Latent biomass model

An alternative approach to the phenomenological one presented above is a model that takes into account the latent biomass of primary producers to model $P$ mechanistically. Here, I am implementing a version of this type of model from Segatto et al 2020. I am choosing to leave out the density dependance of Biomass, because I do not think that NHC is ever space limited.

$$P(t) = \mu_{P,20} f_{T,L}(t)B_A(t)$$
$$f_{T,L}(t) = \theta_A^{T(t)-20} \frac{PAR(t)}{PAR(t) + K_{PAR}$$
$$B_A(t) = B_A(t-1) + P(t-1) - e^{s(Q(t) - c)}$$
ary(tidyverse)
Where $\
library(lme4)

setwd('C:/Users/Alice Carter/git/nhc_50yl/')

sites <- read_csv('data/siteData/NHCsite_metadata.csv') %>%
  slice(c(1:5, 7))

# Test basic GPP model
P <- dat %>% 
  select(date, site, GPP, GPP.lower, GPP.upper, discharge, 
         temp.water, light, slope) %>%
  group_by(site) %>%
  mutate(GPP_pre = c(NA, GPP[1:(n()-1)]))

P <- filter(P, site == 'CBP') %>%
  mutate(discharge = log(discharge),
         across(.cols = any_of(c('light', 'discharge')), .fns = scale))
mod <- lm(GPP ~ GPP_pre + light + discharge, data = P)
summary(mod)

phi = 0.83
b_light = 0.0364
b_q = .06826
p = numeric()
p[1] = P$GPP[2]
for(i in 2:nrow(P)){
  p[i] = phi * p[i-1] + b_light * P$light[i] + b_q * P$discharge[i]
}
plot(P$date, p, ylim = c(-1,2))
lines(P$date, P$GPP)
plot(P$date, P$light)
m = T))

shapiro.test(dat$GPP)
library(ggpubr)
ggqqplot(dat$ER)
aes(temp.water, GPP, col = factor(month))) +
  geom_point() +
  facet_wrap(~site, scales = 'free_y') +

  geom_smooth(method = lm)

mod <- brms::brm(ER ~ (1 + temp.water| slope +  logQ_mean), data = dat, iter = 1000)
mod


raopagaagLFMrcssResnittlstceua`td%=dae_am